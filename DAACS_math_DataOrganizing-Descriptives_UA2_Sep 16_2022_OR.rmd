---
title: "DAACS_math_DataOrganizing_UA2_Sep16_2022_OR"
author: "Oxana Rosca"
date: "2022-12-11"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(haven)
```

If needed:
setwd("D:OneDrive - University at Albany - SUNY/WorkDirectory")

Load umgc1 data files to get umgc1's variable "qid"
```{r}
load("data_export/DAACS-Results-umgc_2022-09-16.rda")
umgc1.math.items.questions<-math.items.questions
```

Use str_replace() method from stringr package to replace part of a column string 
with another string in R DataFrame. 
```{r}
library(stringr)
umgc1.math.items.questions$qid <- str_replace(umgc1.math.items.questions$qid, 
                                              "Q", "mQ")
```

Load data files
```{r}
load("data_export/DAACS-Results-albany_2022-09-16.rda")
```

*Adjusting UA2's IDs*
To distinguish the DAACS_IDs of different colleges, always add 10,000 to UA2 
DAACS_IDs:
```{r}
daacs$DAACS_ID<-daacs$DAACS_ID+10000
math.items$DAACS_ID<-math.items$DAACS_ID+10000
```


*Duplicates*
Test for duplicate values in math.items.response
Frequencies: How many of non-duplicated IDs?
```{r}
table(duplicated(daacs$DAACS_ID))
```

```{r}
table(duplicated(math.items$DAACS_ID))
```
math.items is a long dataset with many rows per a test-taker


*Consistent QID*

For all analyses involving the data from more than one college, we need 
consistent QID (question ID) values. The QIDs were generated by DAACS 
individually for every college during data collection. 

Because the students at UA2 responded to 174 math questions while the students 
at UMGC1 responded to 175 math questions, I decided to rename the "qid" variable 
generated for the UMGC1 into "uniqueQID" and replace the "qid" variable in UA2 
data by the "uniqueQID" using the items stems variable "question" as a matching 
variable. I do the same process for the reading items although the students of 
the both colleges responded to the same number (180) of the reading items. 

Remove UAlbany2's qid variable
```{r}
math.items<-math.items[,-11]
```
Add UMGC1's qid variable
```{r}
math.items <- merge(math.items,umgc1.math.items.questions,by = 'question', 
                       all.x = TRUE)
```

*Attempts*
How many of each number of attempts?
```{r}
table(math.items$attempt, useNA = 'ifany') %>% print() %>% prop.table()* 100
```

Select the first attempts only
```{r}
math.items <- math.items [math.items$attempt == "1",]
```

*Restructure*
re-structure =long dataset from wide dataset
```{r}
library(maditr)
ua2MathDaacs <- dcast(math.items,DAACS_ID ~ qid,value.var = 'score')
```

*Merge*
Using all.y = TRUE so that we use only students provided from 
UA2. These are all newly enrolled students' data on Sep 16th, 2022 (Removing all 
students that did not take math assessment)
```{r}
ua2MathDaacs <- merge(daacs,ua2MathDaacs,by = 'DAACS_ID', all.y = TRUE)
```

*Test Time*
Calculate test time in min per student:
```{r}
ua2MathDaacs$mathTime= (ua2MathDaacs$mathCompletionDate - 
                          ua2MathDaacs$mathStartDate)
```

To remove the non-numeric substring "min" from the values of mathTime
```{r}
View(ua2MathDaacs)
time_var_temp <- 
lapply(ua2MathDaacs[236],function(x)as.numeric(sub("\\s+\\D+$","",x)))
time_var_temp<-as.data.frame(time_var_temp)
View(time_var_temp)
ua2MathDaacs$mathTime<-time_var_temp$mathTime
View(ua2MathDaacs)
```

see the minimum value in minutes
```{r}
min(ua2MathDaacs$mathTime)
```
1.464817 min

What is the shortest time for a student to get a perfect score
```{r}
min(ua2MathDaacs[ua2MathDaacs$mathTotal == 1.0,]$mathTime)
```
To get at least 70%
```{r}
min(ua2MathDaacs[ua2MathDaacs$mathTotal >= .7,]$mathTime)
```
How many took less than 3 minutes
```{r}
nrow(ua2MathDaacs[ua2MathDaacs$mathTime <= 3,])
```
To create a separate dataset of speedy students,
1)Create a vector of the row numbers of the speedy students:
```{r}
speedy<-which (ua2MathDaacs$mathTime <= 3)
```

2)subset the rows of the speedy students as a dataframe:
```{r}
ua2MathSpeedy<-ua2MathDaacs[speedy, ]
head(ua2MathSpeedy[,c(1,32,236)])
```

3 speedy students with DAACS_ID 10195, 10850, and 11053 took less than 3.5 
minutes for the reading assessment and less than 3 minutes for the math 
assessment.
1 speedy student with DAACS_ID 11121 took less than 3 minutes for the math 
assessment.

Remove 4 speedy students (who completed the assessment in 3 minutes or less)
```{r}
ua2MathDaacs <- ua2MathDaacs[ua2MathDaacs$mathTime > 3,]
```

*Total Score*
Histogram of the math scores in points
```{r}
library(ggplot2)
ggplot(ua2MathDaacs, aes(x = mathTotal)) + 
  geom_histogram(binwidth = 0.055, show.legend = TRUE, color = "purple", 
                 fill = "#999999", alpha = 1) + xlab('math Total') +   
                    ylab('Number of Students')
```
Cut the variable of scores into three categories of dots
```{r}
ua2MathDaacs$mathTotalDots <- cut(ua2MathDaacs$mathTotal,
                            breaks=c(0, 0.65, 0.85, 1),labels=c('1', '2', '3'))
```

To build a bar-plot of the math scores in dots
```{r}
table(ua2MathDaacs$mathTotalDots)
```
```{r}
barplot(table(ua2MathDaacs$mathTotalDots),main="ua2 math Total Score in Dots",
          xlab="math Total in Dots", ylab="Number of Students", border="purple", 
              col="grey", density=100)
```

To check if there are empty rows:
```{r}
ua2MathDaacs_Check<-
  ua2MathDaacs[rowSums(is.na(ua2MathDaacs))!=ncol(ua2MathDaacs),]
```
Comparing the # of cases, there are no empty rows

*Saving New Dataset*
Adding new variables of college and item mQ157 and saving the new data file:
```{r}
ua2MathDaacs$college <- 'UA2'
ua2MathDaacs$mQ157 <- 'NA'
saveRDS(ua2MathDaacs, file = 'ua2MathDaacs.rds')
write_sav(ua2MathDaacs, "ua2MathDaacs.sav")
write.table(ua2MathDaacs, 'ua2MathDaacs.csv', sep=',')
saveRDS(ua2MathSpeedy, file = 'ua2MathSpeedy.rds')
write_sav(ua2MathSpeedy, "ua2MathSpeedy.sav")
write.table(ua2MathSpeedy, 'ua2MathSpeedy.csv', sep=',')
```

*Total Number of Participants and Demographics*
how many paricipants and variables you have 
```{r}
dim(ua2MathDaacs)
```
Descriptive statistics for math items. Saving the .cvs
```{r}
library(psych)
describe_ua2MathDaacs<-describe(ua2MathDaacs[,c(26:35,62:237)], na.rm = TRUE)
#write.table(describe_ua2MathDaacs, 'ua2MathDaacs_Descriptives.csv', sep=',')
describe_ua2MathDaacs
```
